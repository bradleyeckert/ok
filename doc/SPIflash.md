# SPI Flash

The firmware functions that access SPI Flash are:
```C
int NVMbeginRead (uint32_t faddr);
int NVMbeginWrite (uint32_t faddr);
uint32_t NVMread (int bytes);
void NVMwrite (uint32_t n, int bytes);
void NVMendRW (void);
```
These are included in the VM as `NVM@[`, `NVM![`, `NVM@`, `NVM!`, and `NVM`.

NVM (non-volatile memory)
is implemented using a 32Mb (4 MB) SPI Flash such as
Winbond W25Q32JVSSIQ connected to the MCU's SPI.
Future SPI Flash parts may bigger.
For example, the Winbond W25Q256JVEIQ (512 64KB sectors) is under $2.
The Winbond W25Q01JVZEIQ (2048 64KB sectors) is under $10.

The NVM functions utilize an access table to control access
to 64KB sectors. If the table is 512 bits, for a W25Q256JV,
it is 64 bytes.
At boot time, the SPI Flash is authenticated to populate the access table.

The first 4KB sector of SPI Flash contains a list of blobs.
Each 20-byte table entry consists of:

- 2-byte first sector
- 2-byte last sector
- 16-byte HMAC

The table is a simple linear list.
A "first sector" value of FFFFh terminates the list.
Sector 0 address range is 00001000h to 0000FFFFh. Otherwise,
sector N address range is NNNN0000h to NNNNFFFFh.

The HMAC is a digital signature generated by the MCU.
The private key for the HMAC is in the MCU, preferably a random number
generated by the MCU before programming the SPI Flash.

The system has several blobs in the NVM:

| idx | blob usage |
|-----|------------|
| 0 | Fonts for the LCD - multi-lingual messages and glyph bitmaps |
| 1 | Primary system boot image - binary executable                |
| 2 | Secondary system boot image - binary executable              |
| 3 | Primary application image - VM bytecode                      |
| 4 | Secondary application image - VM bytecode                    |
| 5 | Staging area for firmware update                             |

For testing in the host VM, a `spiflash.bin` file is loaded by `ok`.
A `blobcmp` utility creates `spiflash.bin` from binary blob files
using `TESTPASS_1` in `moleconfig.h` as the private key.

## Messages and fonts

The messages and fonts are compiled by the `fontgen` utility.
See `make.f` in the `utilities/fontgen` folder.
Links within the font are generally 24-bit. 
This blob of data consists of:

- 4-byte address of messages table
- 4-byte size of messages table
- 4-byte address of font structure
- 4-byte blob size
- padding (zeros)
- Messages table, 3-byte address for each entry
- Padding to reach 4K page boundary
- Fonts structure

